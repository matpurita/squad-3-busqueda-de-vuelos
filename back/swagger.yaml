openapi: 3.0.0
info:
  title: Flight Search API
  description: API for searching flights and getting suggestions
  version: 1.0.0

servers:
  - url: https://squad-3-busqueda-de-vuelos-back-prod.vercel.app
    description: Development server

paths:
  /search:
    get:
      summary: Search for flights
      description: Search for flights with optional return flight
      parameters:
        - name: origin
          in: query
          required: true
          schema:
            type: string
            minLength: 3
            maxLength: 3
          description: Origin airport code (IATA)
        - name: destination
          in: query
          required: true
          schema:
            type: string
            minLength: 3
            maxLength: 3
          description: Destination airport code (IATA)
        - name: departureDate
          in: query
          required: true
          schema:
            type: string
            pattern: '^\d{4}-\d{2}-\d{2}$'
          description: Departure date (YYYY-MM-DD)
        - name: departureRange
          in: query
          schema:
            type: integer
            minimum: 0
            maximum: 7
            default: 0
          description: Number of days around departure date
        - name: returnDate
          in: query
          schema:
            type: string
            pattern: '^\d{4}-\d{2}-\d{2}$'
          description: Return date (YYYY-MM-DD) â€” optional
        - name: returnRange
          in: query
          schema:
            type: integer
            minimum: 0
            maximum: 7
            default: 0
          description: Number of days around return date
        - name: passengers
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 9
            default: 1
          description: Number of passengers
        - name: currency
          in: query
          schema:
            type: string
            minLength: 3
            maxLength: 3
            default: USD
          description: Currency code (ISO 4217)
        - name: sort
          in: query
          schema:
            type: string
            enum: [price_asc, price_desc, duration_asc, duration_desc]
          description: Sort criteria for results
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: Number of results per page
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
      responses:
        '200':
          description: Successful search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchResult'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          description: Bad request - Invalid parameters
        '500':
          description: Internal server error

  /search/suggestions:
    get:
      summary: Get flight suggestions
      description: Search for flights based on a query string
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 2
          description: Search query (airport code, city, country, or airline)
      responses:
        '200':
          description: List of flight suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggestions:
                    type: array
                    items:
                      $ref: '#/components/schemas/FlightSuggestion'
        '400':
          description: Bad request - Invalid query
        '500':
          description: Internal server error

  /search/intent:
    post:
      summary: Create booking intent
      description: Records a booking intent and publishes an event to Kafka
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookingIntent'
      responses:
        '201':
          description: Booking recorded successfully
        '400':
          description: Bad request - invalid payload
        '401':
          description: Unauthorized - missing or invalid token
        '500':
          description: Internal server error

  /auth/login:
    post:
      summary: Login user
      description: Authenticate against external auth service
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginPayload'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
        '401':
          description: Invalid credentials
        '500':
          description: Internal server error

  /auth/register:
    post:
      summary: Register user
      description: Register a new user in the external auth service
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterPayload'
      responses:
        '201':
          description: Registration successful
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Registration failed
        '500':
          description: Internal server error

  /auth/login/mock:
    post:
      summary: Mock login
      description: Local mock login for development/testing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginPayload'
      responses:
        '200':
          description: Mock login successful (returns token)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string
        '401':
          description: Invalid credentials
        '500':
          description: Internal server error

  /auth/user:
    get:
      summary: Get user data
      description: Retrieves user data from auth service for authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthPayload'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

  /search/history:
    get:
      summary: Get search history
      description: Retrieves the search history for the authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Search history retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SearchMetric'
        '401':
          description: Unauthorized - missing or invalid token
        '500':
          description: Internal server error

  /metrics/search:
    post:
      summary: Post search metric
      description: Records search metrics and publishes event to Kafka
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchMetric'
      responses:
        '201':
          description: Search metric recorded
        '400':
          description: Bad request - invalid payload
        '500':
          description: Internal server error

  /airport:
    get:
      summary: Get all airports
      description: Retrieve a list of all airports
      responses:
        '200':
          description: List of airports successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Airport'
        '500':
          description: Internal server error

  /airport/AITA:
    get:
      summary: Get all IATA codes
      description: Retrieve a list of all airport IATA codes
      responses:
        '200':
          description: List of IATA codes successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                  minLength: 3
                  maxLength: 3
                example: ["JFK", "LAX", "LHR"]
        '500':
          description: Internal server error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    SearchResult:
      type: object
      properties:
        departure:
          $ref: '#/components/schemas/Flight'
        return:
          $ref: '#/components/schemas/Flight'
        totalPrice:
          type: number

    Flight:
      type: object
      required:
        - id
        - flightNumber
        - departure
        - arrival
        - duration
        - origin
        - destination
        - airline
        - minPrice
        - availableSeats
        - currency
      properties:
        id:
          type: string
        flightNumber:
          type: string
        departure:
          type: string
          format: date-time
        arrival:
          type: string
          format: date-time
        duration:
          type: number
          description: Duration in minutes
        origin:
          $ref: '#/components/schemas/Airport'
        destination:
          $ref: '#/components/schemas/Airport'
        airline:
          $ref: '#/components/schemas/Airline'
        minPrice:
          type: number
        availableSeats:
          type: number
        currency:
          type: string
          minLength: 3
          maxLength: 3
        seats:
          type: array
          items:
            $ref: '#/components/schemas/Seat'
        selectedSeat:
          $ref: '#/components/schemas/Seat'

    Seat:
      type: object
      required:
        - price
        - seatNumber
      properties:
        price:
          type: number
        seatNumber:
          type: string
        isAvailable:
          type: boolean
          default: true
        class:
          $ref: '#/components/schemas/Class'

    Class:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          enum:
            - Economy
            - Premium Economy
            - Business
            - First

    FlightSuggestion:
      type: object
      properties:
        id:
          type: string
        flightNumber:
          type: string
        label:
          type: string
        departure:
          type: string
          format: date-time
        arrival:
          type: string
          format: date-time
        airline:
          $ref: '#/components/schemas/Airline'
        origin:
          $ref: '#/components/schemas/Airport'
        destination:
          $ref: '#/components/schemas/Airport'

    Pagination:
      type: object
      properties:
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    Airport:
      type: object
      required:
        - code
        - city
        - country
      properties:
        code:
          type: string
          minLength: 3
          maxLength: 3
          description: IATA airport code
        name:
          type: string
        city:
          type: string
        country:
          type: string

    Airline:
      type: object
      required:
        - code
        - name
      properties:
        code:
          type: string
          description: Airline IATA code
        name:
          type: string

    BookingIntent:
      type: object
      required:
        - userId
        - flightId
      properties:
        userId:
          type: string
        flightId:
          type: string
        timestamp:
          type: string
          format: date-time

    LoginPayload:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    RegisterPayload:
      type: object
      required:
        - name
        - email
        - password
        - nationalityOrOrigin
      properties:
        name:
          type: string
          minLength: 2
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        nationalityOrOrigin:
          type: string

    AuthPayload:
      type: object
      properties:
        userId:
          type: string
        email:
          type: string
        rol:
          type: string
        exp:
          type: number
        iat:
          type: number

    SearchMetric:
      type: object
      required:
        - flightsFrom
        - flightsTo
        - dateFrom
        - dateTo
        - resultsCount
      properties:
        userId:
          type: string
        flightsFrom:
          type: string
        flightsTo:
          type: string
        dateFrom:
          type: string
        dateTo:
          type: string
        resultsCount:
          type: integer
        timestamp:
          type: string
          format: date-time